<!doctype html>
<html lang="ru">

<head>
  <meta charset="utf-8" />
  <title>WB — Транзитные направления (FBW)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #f6f7fb;
      --card: #ffffff;
      --text: #111827;
      --muted: #6b7280;
      --accent: #2563eb;
      --success: #16a34a;
      --danger: #dc2626;
      --border: #e5e7eb;

      --badge-bg: #f3f4f6;
      --badge-key: #374151;
      --badge-val: #111827;
      --badge-border: #e5e7eb;
    }

    *,
    *::before,
    *::after {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      background: var(--bg);
      color: var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }

    .header {
      padding: 16px;
      border-bottom: 1px solid var(--border);
      background: #ffffffcc;
      backdrop-filter: saturate(150%) blur(6px);
      position: sticky;
      top: 0;
      z-index: 10;
    }

    h1 {
      margin: 0 0 10px;
      font-size: 20px;
    }

    .row {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      align-items: center;
    }

    label.inline {
      display: flex;
      gap: 6px;
      align-items: center;
      font-size: 14px;
    }

    input[type='text'] {
      background: #fff;
      color: var(--text);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 8px 10px;
      width: 260px;
    }

    input[type='checkbox'] {
      transform: translateY(1px);
    }

    button {
      background: var(--accent);
      color: #fff;
      border: 1px solid var(--accent);
      border-radius: 8px;
      padding: 8px 12px;
      font-weight: 600;
      cursor: pointer;
    }

    button.secondary {
      background: #fff;
      color: var(--accent);
      border-color: var(--accent);
    }

    .status {
      margin-top: 8px;
      font-size: 13px;
      color: var(--muted);
    }

    .updated-at {
      margin-left: auto;
      font-size: 12px;
      color: var(--muted);
    }

    .container {
      padding: 16px;
    }

    .layout {
      display: grid;
      grid-template-columns: 340px 1fr;
      gap: 16px;
    }

    .panel {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 12px;
      min-height: 460px;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.04);
    }

    .panel h3 {
      margin: 0 0 10px;
      font-size: 16px;
    }

    .list {
      display: grid;
      gap: 8px;
      max-height: 408px;
      overflow: auto;
    }

    .item {
      padding: 12px;
      border: 1px solid var(--border);
      border-radius: 10px;
      cursor: pointer;
      background: #fff;
      line-height: 1.25;
    }

    .item:hover {
      border-color: #c7d2fe;
      background: #fafaff;
    }

    .item.active {
      border-color: #93c5fd;
      box-shadow: inset 0 0 0 2px #93c5fd55;
      background: #f0f7ff;
    }

    .item .sub {
      margin-top: 4px;
      font-size: 12px;
      color: var(--muted);
    }

    .targets {
      min-height: 408px;
    }

    .card {
      background: #fff;
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 12px;
      margin-bottom: 12px;
      display: grid;
      gap: 10px;
    }

    .card-head {
      display: flex;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
    }

    .title {
      font-weight: 700;
    }

    .status-badge {
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 700;
      border: 1px solid transparent;
    }

    .status-active {
      background: #ecfdf5;
      color: #065f46;
      border-color: #a7f3d0;
    }

    .status-inactive {
      background: #fef2f2;
      color: #991b1b;
      border-color: #fecaca;
    }

    .status-unknown {
      background: #f3f4f6;
      color: #374151;
      border-color: #e5e7eb;
    }

    .badges {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .badge {
      background: var(--badge-bg);
      border: 1px solid var(--badge-border);
      border-radius: 10px;
      padding: 6px 10px;
      font-size: 13px;
      display: inline-flex;
      gap: 6px;
      align-items: baseline;
    }

    .badge .k {
      color: var(--badge-key);
      font-weight: 600;
    }

    .badge .v {
      color: var(--badge-val);
      font-variant-numeric: tabular-nums;
    }

    .muted {
      color: var(--muted);
    }

    .hint {
      font-size: 12px;
      color: var(--muted);
    }

    .topbar {
      display: flex;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }
  </style>
</head>

<body>
  <header class="header">
    <h1>Транзитные направления Wildberries (FBW)</h1>
    <div class="topbar">
      <label class="inline">Поиск склада: <input type="text" id="search" placeholder="имя склада" /></label>
      <label class="inline"><input type="checkbox" id="onlyActive" /> Только активные</label>
      <button id="btnReload" class="secondary">Обновить</button>
      <div id="pageUpdated" class="updated-at">Последнее обновление: —</div>
    </div>
    <div id="status" class="status">Готов</div>
  </header>

  <main class="container">
    <div class="layout">
      <div class="panel">
        <h3>Транзитные склады</h3>
        <div class="hint" style="margin-bottom:8px">
          Кликните на склад — справа появятся назначения и цены
        </div>
        <div id="listA" class="list"></div>
      </div>
      <div class="panel">
        <h3>Склады назначения</h3>
        <div id="edges" class="targets">
          <div class="muted">Выберите склад слева</div>
        </div>
      </div>
    </div>
  </main>

  <script>
    const els = {
      status: document.getElementById('status'),
      pageUpdated: document.getElementById('pageUpdated'),
      listA: document.getElementById('listA'),
      edges: document.getElementById('edges'),
      onlyActive: document.getElementById('onlyActive'),
      search: document.getElementById('search'),
      btnReload: document.getElementById('btnReload'),
    };

    let fullData = [];
    let filtered = [];
    let currentAKey = null;

    function setStatus(msg, type = 'info') {
      els.status.textContent = msg;
      els.status.style.color =
        type === 'error' ? '#dc2626' : type === 'ok' ? '#10b981' : '#6b7280';
    }
    function fmtDate(s) {
      if (!s) return '—';
      const d = new Date(s);
      if (isNaN(d.getTime())) return s;
      return (
        d.getFullYear() +
        '-' +
        String(d.getMonth() + 1).padStart(2, '0') +
        '-' +
        String(d.getDate()).padStart(2, '0') +
        ' ' +
        String(d.getHours()).padStart(2, '0') +
        ':' +
        String(d.getMinutes()).padStart(2, '0')
      );
    }
    function fmtNow() {
      const d = new Date();
      return (
        d.getFullYear() +
        '-' +
        String(d.getMonth() + 1).padStart(2, '0') +
        '-' +
        String(d.getDate()).padStart(2, '0') +
        ' ' +
        String(d.getHours()).padStart(2, '0') +
        ':' +
        String(d.getMinutes()).padStart(2, '0') +
        ':' +
        String(d.getSeconds()).padStart(2, '0')
      );
    }
    function perLiterLabel(min, max) {
      if (min == null && max == null) return '—';
      if (min != null && max == null) return `${min} ₽/л`;
      if (max != null && min == null) return `${max} ₽/л`;
      if (min === max) return `${min} ₽/л`;
      return `${min}–${max} ₽/л`;
    }

    function applyFilters() {
      const q = (els.search.value || '').trim().toLowerCase();
      filtered = fullData.filter((r) => {
        if (els.onlyActive.checked && r.active !== true) return false;
        const from = r.fromWarehouseName || '';
        const to = r.toWarehouseName || '';
        if (!q) return true;
        return (
          String(from).toLowerCase().includes(q) ||
          String(to).toLowerCase().includes(q)
        );
      });
    }

    async function safeJson(res) {
      const text = await res.text();
      if (!text) return null;
      try { return JSON.parse(text); } catch { return null; }
    }

    async function loadData() {
      setStatus('Загрузка…');
      try {
        const res = await fetch('/api/wb-transit.php', {
          headers: { Accept: 'application/json' },
        });
        const data = await safeJson(res);
        if (!res.ok) {
          console.error('Backend error', data);
          setStatus('Ошибка загрузки', 'error');
          fullData = [];
        } else {
          fullData = Array.isArray(data) ? data : [];
          setStatus(`Готово: направлений — ${fullData.length}`, 'ok');
          els.pageUpdated.textContent =
            'Последнее обновление: ' + fmtNow();
        }
        currentAKey = null;
        onStateChanged();
      } catch (e) {
        console.error(e);
        setStatus('Сетевая ошибка', 'error');
        fullData = [];
        onStateChanged();
      }
    }

    function escapeHtml(v) {
      return String(v)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
    }

    function groupBySource(list) {
      const map = new Map();
      for (const r of list) {
        const key = (r.fromWarehouseName || '').toLowerCase();
        if (!map.has(key)) {
          map.set(key, {
            key,
            name: r.fromWarehouseName || '—',
            items: [],
          });
        }
        map.get(key).items.push(r);
      }
      return Array.from(map.values()).sort((a, b) =>
        String(a.name).localeCompare(String(b.name), 'ru'),
      );
    }

    function renderGraph() {
      const groups = groupBySource(filtered);

      els.listA.innerHTML = groups
        .map(
          (g) => `
            <div class="item ${g.key === currentAKey ? 'active' : ''}" data-key="${escapeHtml(
            g.key,
          )}">
              ${escapeHtml(g.name)}
              <div class="sub">направлений: ${g.items.length}</div>
            </div>
          `,
        )
        .join('');

      for (const el of els.listA.querySelectorAll('.item')) {
        el.addEventListener('click', () => {
          currentAKey = el.getAttribute('data-key');
          renderGraph();
        });
      }

      const selected =
        groups.find((g) => g.key === currentAKey) || groups[0] || null;
      if (!selected) {
        els.edges.innerHTML = `<div class="muted">Нет данных</div>`;
        return;
      }
      if (!currentAKey) currentAKey = selected.key;

      const edgesHtml = selected.items
        .sort((a, b) =>
          String(a.toWarehouseName || '').localeCompare(
            String(b.toWarehouseName || ''),
            'ru',
          ),
        )
        .map((r) => {
          const fromName = r.fromWarehouseName || '';
          const toName = r.toWarehouseName || '';

          const perLiter = perLiterLabel(
            r.boxMinPerLiter,
            r.boxMaxPerLiter
          );
          const pallet =
            r.palletTariff != null && r.palletTariff !== ''
              ? `${r.palletTariff} ₽/паллета`
              : '—';

          let statusClass = 'status-unknown';
          let statusText = 'Неизвестно';
          if (r.active === true) {
            statusClass = 'status-active';
            statusText = 'Активно';
          } else if (r.active === false) {
            statusClass = 'status-inactive';
            statusText = 'Неактивно';
          }

          return `
              <div class="card">
                <div class="card-head">
                  <span class="status-badge ${statusClass}">${statusText}</span>
                  <span class="title">${escapeHtml(fromName)} → ${escapeHtml(
            toName,
          )}</span>
                </div>
                <div class="badges">
                  <span class="badge"><span class="k">За литр:</span><span class="v">${escapeHtml(
            perLiter,
          )}</span></span>
                  <span class="badge"><span class="k">Паллета:</span><span class="v">${escapeHtml(
            pallet,
          )}</span></span>
                  <span class="badge"><span class="k">Доступен с:</span><span class="v">${escapeHtml(
            fmtDate(r.updatedAt),
          )}</span></span>
                </div>
              </div>
            `;
        })
        .join('');

      els.edges.innerHTML = edgesHtml || `<div class="muted">Нет связей</div>`;
    }

    function onStateChanged() {
      applyFilters();
      renderGraph();
    }

    els.onlyActive.addEventListener('change', onStateChanged);
    els.search.addEventListener('input', onStateChanged);
    els.btnReload.addEventListener('click', loadData);
    document.addEventListener('DOMContentLoaded', loadData);
  </script>
</body>

</html>