<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>WB Promotions Calendar</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js"></script>
    <style>
      :root {
        --bg: #0f1115;
        --panel: #161a22;
        --muted: #94a3b8;
        --text: #e5e7eb;
        --accent: #7c3aed;
        --ok: #16a34a;
        --chip: #1f2937;
      }
      html, body { margin: 0; height: 100%; background: var(--bg); color: var(--text); font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
      .wrap { display: grid; grid-template-columns: 340px 1fr; gap: 16px; height: 100%; padding: 16px; box-sizing: border-box; }
      .side { background: var(--panel); border-radius: 12px; padding: 16px; overflow: auto; }
      .cal { background: var(--panel); border-radius: 12px; padding: 12px; }
      .legend { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; margin-top: 12px; }
      .dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; margin-right: 6px; }
      .fc-event.active { background: rgba(22, 163, 74, 0.15); border-color: var(--ok); color: #a7f3d0; }
      .fc-event.inactive { background: rgba(124, 58, 237, 0.15); border-color: var(--accent); color: #ddd6fe; }
      .row { margin-bottom: 12px; }
      .chips { display: flex; gap: 8px; flex-wrap: wrap; }
      .chip { padding: 4px 8px; border-radius: 999px; background: var(--chip); font-size: 12px; color: var(--muted); }
      .details { margin-top: 16px; padding: 12px; border-radius: 10px; background: #111521; border: 1px solid #23304a; }
      .details h3 { margin: 0 0 6px; font-size: 16px; }
      .kv { font-size: 13px; color: var(--muted); margin: 4px 0; white-space: pre-wrap; }
      .err { color: #fecaca; background: #331a1a; border: 1px solid #7f1d1d; padding: 10px; border-radius: 8px; font-size: 14px; }
      button { padding: 8px 10px; border-radius: 8px; border: 1px solid #293042; background: #0f1320; color: var(--text); }
      input { width: 100%; padding: 8px 10px; border-radius: 8px; border: 1px solid #293042; background: #0f1320; color: var(--text); }
      label { display: block; font-size: 12px; color: var(--muted); margin-bottom: 6px; }
    </style>
  </head>
  <body>
    <div class="wrap">
      <aside class="side">
        <h2>WB Promotions</h2>

        <div class="row">
          <label for="q">Search (name/description)</label>
          <input id="q" type="text" placeholder="Type to filter..." />
        </div>

        <div class="chips" id="chips"></div>

        <div class="details" id="details" hidden>
          <h3 id="d-title"></h3>
          <div class="kv" id="d-when"></div>
          <div class="kv" id="d-type"></div>
          <div class="kv" id="d-adv"></div>
          <div class="kv" id="d-desc"></div>
          <div class="kv" id="d-stats"></div>
          <div class="kv" id="d-exc"></div>
          <div class="kv" id="d-rng"></div>
        </div>

        <div id="error" class="err" hidden></div>

        <div class="legend">
          <span><span class="dot" style="background: var(--ok)"></span>Active</span>
          <span><span class="dot" style="background: var(--accent)"></span>Upcoming/Past</span>
        </div>
      </aside>

      <main class="cal">
        <div id="calendar"></div>
      </main>
    </div>

    <script>
      const ENDPOINT = '/api/wb-promotions-details.php';

      let rawItems = [];
      let filtered = [];
      let calendar;

      const qEl = document.getElementById('q');
      const chipsEl = document.getElementById('chips');
      const errorEl = document.getElementById('error');

      const detailsBox = document.getElementById('details');
      const dTitle = document.getElementById('d-title');
      const dWhen = document.getElementById('d-when');
      const dType = document.getElementById('d-type');
      const dAdv = document.getElementById('d-adv');
      const dDesc = document.getElementById('d-desc');
      const dStats = document.getElementById('d-stats');
      const dExc = document.getElementById('d-exc');
      const dRng = document.getElementById('d-rng');

      function initCalendar(events) {
        const el = document.getElementById('calendar');
        if (calendar) calendar.destroy();
        calendar = new FullCalendar.Calendar(el, {
          initialView: 'dayGridMonth',
          height: '100%',
          headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: 'dayGridMonth,timeGridWeek,listWeek',
          },
          eventDisplay: 'block',
          events,
          eventClick: (info) => {
            const d = info.event.extendedProps.raw || {};
            showDetails(info.event.title, info.event.start, info.event.end, d);
          },
          eventDidMount: (arg) => {
            const active = !!arg.event.extendedProps.active;
            arg.el.classList.add(active ? 'active' : 'inactive');
          },
        });
        calendar.render();
      }

      function toEvents(items) {
        return items.map((x) => ({
          id: x.id != null ? String(x.id) : undefined,
          title: x.name || '(No name)',
          start: x.startDate || null,
          end: x.endDate || null,
          allDay: true,
          active: !!x.active,
          raw: x,
        }));
      }

      function applyFilters() {
        const q = qEl.value.trim().toLowerCase();
        filtered = rawItems.filter((x) => {
          if (!q) return true;
          const hay = `${x.name || ''} ${x.description || ''} ${(x.advantages || []).join(' ')}`;
          return hay.toLowerCase().includes(q);
        });
        initCalendar(toEvents(filtered));
        updateChips();
      }

      function fmtDate(d) {
        return d
          ? new Date(d).toLocaleString(undefined, { year: 'numeric', month: 'short', day: '2-digit' })
          : '—';
      }

      function showDetails(title, start, end, raw) {
        dTitle.textContent = title || '(No name)';
        dWhen.textContent = `When: ${fmtDate(start)} — ${fmtDate(end)}`;
        dType.textContent = `Type: ${raw.type || '—'}`;

        const adv = Array.isArray(raw.advantages) ? raw.advantages.filter(Boolean) : [];
        dAdv.textContent = adv.length ? 'Advantages: ' + adv.join('; ') : 'Advantages: —';

        dDesc.textContent = raw.description ? `Description: ${raw.description}` : 'Description: —';

        const s1 = raw.inPromoActionLeftovers != null ? `in-stock in promo: ${raw.inPromoActionLeftovers}` : null;
        const s2 = raw.inPromoActionTotal != null ? `total in promo: ${raw.inPromoActionTotal}` : null;
        const s3 = raw.notInPromoActionLeftovers != null ? `in-stock not in promo: ${raw.notInPromoActionLeftovers}` : null;
        const s4 = raw.notInPromoActionTotal != null ? `total not in promo: ${raw.notInPromoActionTotal}` : null;
        const s5 = raw.participationPercentage != null ? `participation: ${raw.participationPercentage}%` : null;
        dStats.textContent = ['Stats:', s1, s2, s3, s4, s5].filter(Boolean).join(' | ') || 'Stats: —';

        dExc.textContent =
          raw.type === 'auto' && raw.exceptionProductsCount != null
            ? `Excluded before start (auto): ${raw.exceptionProductsCount}`
            : 'Excluded before start: —';

        const rng = Array.isArray(raw.ranging) ? raw.ranging : [];
        dRng.textContent = rng.length ? `Ranging: ${JSON.stringify(rng)}` : 'Ranging: —';

        detailsBox.hidden = false;
      }

      function updateChips() {
        chipsEl.innerHTML = '';
        const total = document.createElement('span');
        total.className = 'chip';
        total.textContent = `Shown: ${filtered.length}`;
        chipsEl.appendChild(total);
        const activeCnt = filtered.filter((x) => x.active).length;
        const c2 = document.createElement('span');
        c2.className = 'chip';
        c2.textContent = `Active: ${activeCnt}`;
        chipsEl.appendChild(c2);
      }

      async function load() {
        errorEl.hidden = true;
        detailsBox.hidden = true;
        try {
          const res = await fetch(ENDPOINT, { cache: 'no-store' });
          if (!res.ok) {
            const text = await res.text();
            throw new Error(`HTTP ${res.status}: ${text}`);
          }
          const data = await res.json();
          if (!Array.isArray(data)) throw new Error('Invalid payload');
          rawItems = data;
          filtered = data.slice();
          applyFilters(); // renders calendar and chips
        } catch (e) {
          errorEl.textContent = 'Failed to load promotions: ' + e.message;
          errorEl.hidden = false;
          console.error(e);
        }
      }

      qEl.addEventListener('input', debounce(applyFilters, 200));
      function debounce(fn, ms) { let t; return (...a) => { clearTimeout(t); t = setTimeout(() => fn(...a), ms); }; }

      load();
    </script>
  </body>
</html>