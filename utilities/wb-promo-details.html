<!doctype html>
<html lang="ru">
  <head>
    <meta charset="utf-8" />
    <title>Акции WB — узкий месяц (пастельные цвета, детали снизу)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <link
      href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js"></script>

    <style>
      :root {
        --bg: #ffffff;
        --panel: #ffffff;
        --muted: #475569; /* slate-600 */
        --text: #0f172a;  /* slate-900 */
        --border: #e5e7eb;
        --chip: #f3f4f6;

        --status-active-bg: #eaf7ef;
        --status-active-border: #16a34a;
        --status-active-text: #06603e;

        --status-planned-bg: #eef2ff;
        --status-planned-border: #6366f1;
        --status-planned-text: #3730a3;
      }

      html, body {
        margin: 0;
        background: var(--bg);
        color: var(--text);
        font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      }

      .wrap {
        display: grid;
        grid-template-columns: 15% 85%;
        gap: 12px;
        min-height: 100vh;
        padding: 12px;
        box-sizing: border-box;
      }

      .panel {
        background: var(--panel);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 12px;
        overflow: hidden;
      }

      .row { margin-bottom: 10px; }

      input, select {
        width: 100%;
        padding: 9px 10px;
        border-radius: 10px;
        border: 1px solid var(--border);
        background: #fff;
        color: var(--text);
        font-size: 14px;
      }

      .chips {
        display: flex;
        gap: 6px;
        flex-wrap: wrap;
        margin: 6px 0 10px 0;
      }
      .chip {
        padding: 3px 8px;
        background: var(--chip);
        border: 1px solid var(--border);
        border-radius: 999px;
        font-size: 12px;
        color: var(--muted);
        white-space: nowrap;
      }

      /* LEFT list */
      .list { display: grid; gap: 10px; }
      .item {
        background: #fff;
        border: 2px solid var(--border);
        border-radius: 12px;
        padding: 12px;
        cursor: pointer;
        transition: box-shadow 0.15s ease, border-color 0.15s ease, background 0.15s ease, color 0.15s ease;
      }
      .item:hover { box-shadow: 0 1px 6px rgba(0,0,0,.08); }
      .title { font-weight: 600; font-size: 13px; }
      .sub   { color: var(--muted); font-size: 12px; margin-top: 4px; }

      .topline {
        display: flex; justify-content: space-between; align-items: center;
        gap: 8px; flex-wrap: wrap;
      }
      .pills { display: inline-flex; gap: 6px; align-items: center; }
      .pill {
        padding: 2px 8px; border-radius: 999px; border: 1px solid var(--border);
        font-size: 11px; white-space: nowrap; background: #fff; color: var(--muted);
      }
      .status-active {
        background: var(--status-active-bg);
        border-color: var(--status-active-border);
        color: var(--status-active-text);
      }
      .status-planned {
        background: var(--status-planned-bg);
        border-color: var(--status-planned-border);
        color: var(--status-planned-text);
      }

      /* RIGHT column: calendar top (75%), details bottom (25%) */
      .right {
        display: grid;
        grid-template-rows: auto minmax(300px, 1fr) minmax(220px, 25vh);
        gap: 10px;
        min-height: 0;
      }
      #calendar {
        background: #fff; border: 1px solid var(--border); border-radius: 12px;
        padding: 6px; min-height: 320px;
      }

      /* FullCalendar toolbar */
      .fc .fc-toolbar-title { font-size: 18px; font-weight: 700; color: var(--text); }
      .fc .fc-button {
        background: #f8fafc; border: 1px solid var(--border); color: var(--text);
        padding: 5px 9px; border-radius: 8px; text-transform: none;
      }
      .fc .fc-button-primary:not(:disabled):hover { background: #eef2f7; border-color: #d1d5db; }
      .fc-theme-standard td, .fc-theme-standard th { border-color: var(--border); }

      /* Compact header line */
      .fc .fc-col-header-cell-cushion { font-size: 12px; padding: 2px 0; }

      /* Month/week: taller event rows (less crammed) */
      .fc-daygrid-event {
        margin-top: 3px;             /* more vertical space */
        padding: 3px 6px;            /* taller chips */
        border-radius: 8px;
        line-height: 1.25;
        font-size: 12px;
      }
      .fc-timegrid-event {
        border-radius: 8px;
        padding: 4px 6px;
        font-size: 12px;
        line-height: 1.25;
      }

      /* Hide time rows; show only all-day area in our narrow month */
      .fc-timegrid-slot, .fc-timegrid-slots, .fc-timegrid-axis { display: none !important; }
      .fc-timegrid .fc-timegrid-body { display: none !important; }
      .fc-timegrid .fc-timegrid-allday { display: block !important; }

      /* Always filled pastel background in month/week, controlled via inline style (JS).
         Ensure event text inherits color we set in JS. */
      .fc .fc-event, .fc .fc-timegrid-event, .fc .fc-daygrid-event { color: inherit !important; }
      .fc .fc-event, .fc .fc-event * { color: inherit; }

      /* DETAILS bottom fixed area */
      .details {
        background: #fff; border: 1px solid var(--border); border-radius: 12px;
        padding: 12px; overflow: auto;
      }
      .kv { margin: 6px 0; color: var(--muted); white-space: pre-wrap; }

      .err { color: #b91c1c; background: #fee2e2; border: 1px solid #fecaca; padding: 10px; border-radius: 10px; font-size: 14px; }

      @media (max-width: 960px) {
        .wrap { grid-template-columns: 1fr; }
        .right { grid-template-rows: auto minmax(240px, 1fr) minmax(200px, 30vh); }
      }
    </style>
  </head>
  <body>
    <div class="wrap">
      <!-- LEFT -->
      <aside class="panel">
        <h3 style="margin:0 0 6px;">Список акций</h3>
        <div class="row">
          <input id="q" type="text" placeholder="Поиск по названию/описанию..." />
        </div>
        <div class="row" style="display:grid;grid-template-columns:1fr 1fr;gap:6px;">
          <select id="typeFilter">
            <option value="">Все типы</option>
            <option value="regular">регулярная</option>
            <option value="auto">авто</option>
          </select>
          <select id="sortBy">
            <option value="active">Активные вначале</option>
            <option value="startAsc">Дата начала ↑</option>
            <option value="startDesc">Дата начала ↓</option>
            <option value="nameAsc">Название А→Я</option>
            <option value="nameDesc">Название Я→А</option>
          </select>
        </div>
        <div class="chips" id="chips"></div>
        <div id="list" class="list"></div>
        <div id="error" class="err" hidden></div>
      </aside>

      <!-- RIGHT -->
      <section class="right">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;">
          <h3 style="margin:0;">Календарь (узкий месяц)</h3>
          <div class="chips">
            <span class="chip">Сегодня: <span id="today"></span></span>
            <span class="chip">Вид: узкий месяц / неделя / список</span>
          </div>
        </div>

        <div id="calendar"></div>

        <!-- Persistent details area (25% height) -->
        <div id="details" class="details">
          <h3 id="d-title" style="margin:0 0 6px;">Детали акции</h3>
          <div class="kv" id="d-when">Период: —</div>
          <div class="kv" id="d-type">Тип: —</div>
          <div class="kv" id="d-adv">Преимущества: —</div>
          <div class="kv" id="d-boost">Диапазон бустинга: —</div>
          <div class="kv" id="d-desc">Описание: —</div>
        </div>
      </section>
    </div>

    <script>
      const ENDPOINT = '/api/wb-promo-details.php';
      const EXCLUDE_BY_NAME = ['Распродажа в счет долга'];

      // Softer pastel palette (stroke and fill base)
      const PASTEL_PALETTE = [
        '#7cc3ff', // pastel sky
        '#8bd8c1', // mint/teal
        '#ffd28a', // amber soft
        '#ffa3a3', // red soft
        '#c7b4f5', // violet soft
        '#a0e0ff', // cyan soft
        '#f9a8d4', // pink soft
        '#b2f2a7', // green soft
        '#fbcfe8', // rose pale
        '#fde68a', // yellow pale
        '#c4b5fd', // indigo soft
        '#86efac', // emerald soft
      ];

      function colorForId(id) {
        const i = Math.abs(Number(id) || 0);
        return PASTEL_PALETTE[i % PASTEL_PALETTE.length];
      }
      function isDark(hex) {
        const c = hex.replace('#', '');
        const r = parseInt(c.substring(0, 2), 16);
        const g = parseInt(c.substring(2, 4), 16);
        const b = parseInt(c.substring(4, 6), 16);
        const L = (0.299 * r + 0.587 * g + 0.114 * b) / 255;
        return L < 0.55;
      }
      function hexToRgb(hex) {
        const c = hex.replace('#', '');
        return {
          r: parseInt(c.substring(0, 2), 16),
          g: parseInt(c.substring(2, 4), 16),
          b: parseInt(c.substring(4, 6), 16),
        };
      }
      function rgba(hex, a) {
        const { r, g, b } = hexToRgb(hex);
        return `rgba(${r}, ${g}, ${b}, ${a})`;
      }

      const listEl = document.getElementById('list');
      const detailsBox = document.getElementById('details');
      const dTitle = document.getElementById('d-title');
      const dWhen = document.getElementById('d-when');
      const dType = document.getElementById('d-type');
      const dAdv = document.getElementById('d-adv');
      const dBoost = document.getElementById('d-boost');
      const dDesc = document.getElementById('d-desc');
      const chipsEl = document.getElementById('chips');
      const errorEl = document.getElementById('error');
      const qEl = document.getElementById('q');
      const sortEl = document.getElementById('sortBy');
      const typeEl = document.getElementById('typeFilter');
      const todayEl = document.getElementById('today');

      let all = [];
      let filtered = [];
      let selectedId = null;
      let calendar;
      let eventElsById = new Map();

      todayEl.textContent = new Date().toLocaleDateString('ru-RU', {
        year: 'numeric', month: 'long', day: '2-digit',
      });

      function fmt(d) {
        return d
          ? new Date(d).toLocaleString('ru-RU', { year: 'numeric', month: 'short', day: '2-digit' })
          : '—';
      }
      function typeRu(type) { return type === 'auto' ? 'авто' : (type === 'regular' ? 'регулярная' : '—'); }
      function typeClass(type) { return type === 'auto' ? 'type-auto' : 'type-regular'; }
      function statusPillText(active) { return active ? 'Активна' : 'Запланирована'; }

      function compactAdvantages(arr) {
        if (!Array.isArray(arr) || !arr.length) return '—';
        const top = arr.filter(Boolean).slice(0, 2);
        let text = top.join(', ');
        if (arr.length > 2) text += ` +${arr.length - 2}`;
        return text || '—';
      }
      function getBoostRange(ranging) {
        if (!Array.isArray(ranging) || !ranging.length) return null;
        let min = null, max = null;
        for (const r of ranging) {
          const b = typeof r?.boost === 'number' ? r.boost : null;
          if (b == null) continue;
          if (min == null || b < min) min = b;
          if (max == null || b > max) max = b;
        }
        if (min == null && max == null) return null;
        if (min != null && max != null) return `${min}–${max}%`;
        return `${min ?? max}%`;
      }

      function buildEventContent(arg) {
        const e = arg.event.extendedProps.raw;
        const name = arg.event.title || '(без названия)';
        const typeP = `<span class="pill ${typeClass(e.type)}" style="border-color:#cbd5e1;color:#64748b;background:#f8fafc">${typeRu(e.type)}</span>`;
        const adv = compactAdvantages(e.advantages);
        const boost = getBoostRange(e.ranging);
        const parts = [];
        if (adv && adv !== '—') parts.push(adv);
        if (boost) parts.push(`бустинг: ${boost}`);
        const meta = parts.join(' • ');
        const container = document.createElement('div');
        container.innerHTML = `
          <div class="ev-title" style="font-weight:600">${name} ${typeP}</div>
          <div class="ev-meta" style="opacity:.9">${meta}</div>
        `;
        return { domNodes: [container] };
      }

      // Non-selected opacity for fill
      const FILL_OPACITY = 0.28; // ~28% pastel fill
      function styleEventElement(el, color, selected) {
        // border uses solid pastel color
        el.style.borderColor = color;
        el.style.borderWidth = '2px';
        el.style.borderStyle = 'solid';

        // filled background always visible in month/week; opacity changes with selection
        const bg = selected ? color : rgba(color, FILL_OPACITY);
        el.style.background = bg;

        // text contrast
        const txt = selected ? (isDark(color) ? '#ffffff' : '#000000') : '#000000';
        el.style.color = txt;
        el.querySelectorAll('*').forEach(n => (n.style.color = txt));
      }

      function registerEventEl(id, el) {
        if (!eventElsById.has(id)) eventElsById.set(id, []);
        eventElsById.get(id).push(el);
      }
      function applySelectionStyles() {
        for (const [id, nodes] of eventElsById.entries()) {
          const color = colorForId(id);
          const sel = String(selectedId) === String(id);
          (nodes || []).forEach((el) => styleEventElement(el, color, sel));
        }
      }

      function toEvents(items) {
        return items.map((p) => ({
          id: String(p.id),
          title: p.name || '(без названия)',
          start: p.startDate || null,
          end: p.endDate || null,
          allDay: true,
          active: !!p.active,
          raw: p,
        }));
      }

      function chip(text) {
        const el = document.createElement('span');
        el.className = 'chip';
        el.textContent = text;
        return el;
      }
      function renderChips() {
        chipsEl.innerHTML = '';
        chipsEl.appendChild(chip(`Показано: ${filtered.length}`));
        chipsEl.appendChild(chip(`Активных: ${filtered.filter((x) => x.active).length}`));
        chipsEl.appendChild(chip(`регулярная: ${filtered.filter((x) => x.type === 'regular').length}`));
        chipsEl.appendChild(chip(`авто: ${filtered.filter((x) => x.type === 'auto').length}`));
      }

      function renderList() {
        listEl.innerHTML = '';
        filtered.forEach((p) => {
          const div = document.createElement('div');
          const color = colorForId(p.id);
          const sel = selectedId === p.id;

          div.className = 'item' + (sel ? ' active' : '');
          // pastel border
          div.style.borderColor = color;
          // pastel fill in list too, light opacity; stronger if selected
          div.style.background = sel ? rgba(color, 0.25) : rgba(color, 0.12);
          div.style.color = '#0f172a';

          const statusClass = p.active ? 'status-active' : 'status-planned';
          const textColorStyle = ''; // keep dark for list
          const subColorStyle = 'style="color:var(--muted)"';

          div.innerHTML = `
            <div class="topline">
              <div class="title" ${textColorStyle}>${p.name || '(без названия)'}</div>
              <div class="pills">
                <span class="pill ${statusClass}">${statusPillText(p.active)}</span>
                <span class="pill" style="border-color:#cbd5e1;color:#64748b;background:#f8fafc">${typeRu(p.type)}</span>
              </div>
            </div>
            <div class="sub" ${subColorStyle}>${fmt(p.startDate)} — ${fmt(p.endDate)}</div>
          `;

          div.onclick = () => {
            selectedId = p.id;
            applySelectionStyles();
            renderList();
            showDetails(p);
            if (p.startDate && calendar) calendar.gotoDate(p.startDate);
          };
          listEl.appendChild(div);
        });
      }

      function showDetails(p) {
        if (!p) {
          dTitle.textContent = 'Детали акции';
          dWhen.textContent = 'Период: —';
          dType.textContent = 'Тип: —';
          dAdv.textContent = 'Преимущества: —';
          dBoost.textContent = 'Диапазон бустинга: —';
          dDesc.textContent = 'Описание: —';
          return;
        }
        const adv = Array.isArray(p.advantages) ? p.advantages.filter(Boolean) : [];
        const boost = getBoostRange(p.ranging);
        const color = colorForId(p.id);

        dTitle.innerHTML = `${p.name || '(без названия)'} <span class="pill" style="border-color:#cbd5e1;color:#64748b;background:#f8fafc">${typeRu(p.type)}</span>`;
        dTitle.style.borderLeft = `6px solid ${color}`;
        dTitle.style.paddingLeft = '8px';
        dTitle.style.color = '#0f172a';

        dWhen.textContent = `Период: ${fmt(p.startDate)} — ${fmt(p.endDate)}`;
        dType.textContent = `Тип: ${typeRu(p.type)}`;
        dAdv.textContent = `Преимущества: ${adv.length ? adv.join(', ') : '—'}`;
        dBoost.textContent = `Диапазон бустинга: ${boost || '—'}`;
        dDesc.textContent = `Описание: ${p.description || '—'}`;
      }

      function sortItems(items, mode) {
        const copy = items.slice();
        const cmpStr = (a, b) =>
          String(a || '').localeCompare(String(b || ''), 'ru', { sensitivity: 'base' });
        const cmpDate = (a, b) => String(a || '').localeCompare(String(b || ''));
        switch (mode) {
          case 'startAsc': return copy.sort((a, b) => cmpDate(a.startDate, b.startDate));
          case 'startDesc': return copy.sort((a, b) => cmpDate(b.startDate, a.startDate));
          case 'nameAsc': return copy.sort((a, b) => cmpStr(a.name, b.name));
          case 'nameDesc': return copy.sort((a, b) => cmpStr(b.name, a.name));
          case 'active':
          default:
            return copy.sort((a, b) => {
              const aa = a.active ? 1 : 0, bb = b.active ? 1 : 0;
              if (aa !== bb) return bb - aa;
              const d = cmpDate(a.startDate, b.startDate);
              if (d !== 0) return d;
              return cmpStr(a.name, b.name);
            });
        }
      }

      // Narrow-month helpers (timeGrid month made of 28..31 columns)
      function firstOfMonth(d) {
        const x = new Date(Date.UTC(d.getUTCFullYear(), d.getUTCMonth(), 1));
        return x;
      }
      function monthLength(d) {
        const y = d.getUTCFullYear();
        const m = d.getUTCMonth();
        return new Date(Date.UTC(y, m + 1, 0)).getUTCDate();
      }

      function initCalendar(events) {
        const el = document.getElementById('calendar');
        if (calendar) { calendar.destroy(); eventElsById.clear(); }

        const now = new Date();
        const start = firstOfMonth(new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), 1)));
        const days = monthLength(start); // 28..31

        calendar = new FullCalendar.Calendar(el, {
          locale: 'ru',
          timeZone: 'UTC',

          initialView: 'timeGridMonthNarrow',
          initialDate: start.toISOString(),
          headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: 'timeGridMonthNarrow,timeGridWeek,listWeek',
          },
          buttonText: {
            today: 'сегодня',
            timeGridMonthNarrow: 'узкий месяц',
            week: 'неделя',
            list: 'список',
          },

          views: {
            timeGridMonthNarrow: {
              type: 'timeGrid',
              duration: { days },
              slotDuration: '24:00',
              allDaySlot: true,
              dayHeaderFormat: { weekday: 'short', day: 'numeric' },
            },
          },

          events,
          eventDisplay: 'block',
          eventTimeFormat: false,

          // Let day cells hold more visible rows before collapsing into "+ещё"
          dayMaxEvents: 8,

          eventDidMount: (arg) => {
            const p = arg.event.extendedProps.raw;
            const color = colorForId(p.id);
            const sel = selectedId === p.id;
            styleEventElement(arg.el, color, sel);
            registerEventEl(String(p.id), arg.el);
          },
          eventClick: (info) => {
            const d = info.event.extendedProps.raw || {};
            selectedId = d.id ?? null;
            applySelectionStyles();
            renderList();
            showDetails(d);
          },
          eventContent: buildEventContent,
        });

        calendar.render();
        calendar.gotoDate(start);
      }

      async function load() {
        errorEl.hidden = true;
        try {
          const res = await fetch(ENDPOINT, { cache: 'no-store' });
          if (!res.ok) throw new Error(`HTTP ${res.status}: ${await res.text()}`);
          const data = await res.json();
          if (!Array.isArray(data)) throw new Error('Некорректный ответ сервера');
          all = data;
          selectedId = null;
          applyFilter();
        } catch (e) {
          errorEl.textContent = 'Не удалось загрузить акции: ' + e.message;
          errorEl.hidden = false;
          console.error(e);
        }
      }

      function applyFilter() {
        const q = qEl.value.trim().toLowerCase();
        const t = typeEl.value;

        filtered = all.filter((p) => {
          if (EXCLUDE_BY_NAME.includes(p.name || '')) return false;
          if (t && p.type !== t) return false;
          if (!q) return true;
          const hay = `${p.name || ''} ${p.description || ''} ${(p.advantages || []).join(' ')}`;
          return hay.toLowerCase().includes(q);
        });

        filtered = sortItems(filtered, sortEl.value);

        if (filtered.length && !filtered.some((x) => x.id === selectedId)) {
          selectedId = filtered[0].id;
        }

        renderChips();
        initCalendar(toEvents(filtered));
        renderList();
        showDetails(filtered.find((x) => x.id === selectedId) || null);
      }

      qEl.addEventListener('input', debounce(applyFilter, 200));
      sortEl.addEventListener('change', applyFilter);
      typeEl.addEventListener('change', applyFilter);

      function debounce(fn, ms) { let t; return (...a) => { clearTimeout(t); t = setTimeout(() => fn(...a), ms); }; }

      load();
    </script>
  </body>
</html>