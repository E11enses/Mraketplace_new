<!doctype html>
<html lang="ru">

<head>
  <meta charset="utf-8" />
  <title>WB — Транзитные направления (FBW/FBO)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #f6f7fb;
      --card: #ffffff;
      --text: #111827;
      --muted: #6b7280;
      --accent: #2563eb;
      --success: #16a34a;
      --danger: #dc2626;
      --border: #e5e7eb;

      --badge-bg: #f3f4f6;
      --badge-key: #374151;
      --badge-val: #111827;
      --badge-border: #e5e7eb;
    }

    *,
    *::before,
    *::after {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      background: var(--bg);
      color: var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }

    .header {
      padding: 12px 16px;
      border-bottom: 1px solid var(--border);
      background: #ffffffcc;
      backdrop-filter: saturate(150%) blur(6px);
      position: sticky;
      top: 0;
      z-index: 10;
    }

    h1 {
      margin: 0 0 8px;
      font-size: 20px;
    }

    .topbar {
      display: grid;
      grid-template-columns: 1fr auto auto;
      gap: 8px;
      align-items: center;
    }

    .search-wrap {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .search-wrap input[type='text'] {
      background: #fff;
      color: var(--text);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 8px 10px;
      width: 100%;
      min-width: 140px;
    }

    .controls {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .back-to-site {
      margin-top: 25px;
      font-size: 16px;
    }

    .back-to-site a {
      color: var(--accent);
      text-decoration: none;
      padding: 6px 6px;
      border: 2px solid var(--accent);
    }

    .back-to-site a:hover {
      background: var(--accent);
      color: var(--bg);
    }

    .checkbox {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 14px;
      color: var(--text);
      white-space: nowrap;
    }

    button {
      background: var(--accent);
      color: #fff;
      border: 1px solid var(--accent);
      border-radius: 8px;
      padding: 8px 12px;
      font-weight: 600;
      cursor: pointer;
      font-size: 14px;
      white-space: nowrap;
    }

    .status-row {
      margin-top: 8px;
      display: flex;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
      font-size: 14px;
    }

    .page-updated {
      color: var(--muted);
      margin-left: auto;
    }

    .status-inline {
      color: #059669;
      white-space: nowrap;
    }

    .container {
      padding: 12px 16px 16px;
    }

    .layout {
      display: grid;
      grid-template-columns: 1fr;
      gap: 12px;
    }

    .panel {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 10px;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.04);
    }

    .panel h3 {
      margin: 0 0 8px;
      font-size: 16px;
    }

    .hint {
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 6px;
    }

    .list {
      display: grid;
      gap: 8px;
      max-height: 50vh;
      overflow: auto;
    }

    .item {
      padding: 10px;
      border: 1px solid var(--border);
      border-radius: 10px;
      cursor: pointer;
      background: #fff;
      line-height: 1.25;
    }

    .item:hover {
      border-color: #c7d2fe;
      background: #fafaff;
    }

    .item.active {
      border-color: #93c5fd;
      box-shadow: inset 0 0 0 2px #93c5fd55;
      background: #f0f7ff;
    }

    .item .sub {
      margin-top: 2px;
      font-size: 12px;
      color: var(--muted);
    }

    .targets {
      min-height: 40vh;
    }

    .card {
      background: #fff;
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 10px;
      margin-bottom: 10px;
      display: grid;
      gap: 8px;
    }

    .card-head {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
    }

    .title {
      font-weight: 700;
    }

    .status-badge {
      padding: 3px 8px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 700;
      border: 1px solid transparent;
    }

    .status-active {
      background: #ecfdf5;
      color: #065f46;
      border-color: #a7f3d0;
    }

    .status-inactive {
      background: #fef2f2;
      color: #991b1b;
      border-color: #fecaca;
    }

    .status-unknown {
      background: #f3f4f6;
      color: #374151;
      border-color: #e5e7eb;
    }

    .badges {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .badge {
      background: var(--badge-bg);
      border: 1px solid var(--badge-border);
      border-radius: 10px;
      padding: 5px 8px;
      font-size: 12px;
      display: inline-flex;
      gap: 6px;
      align-items: baseline;
    }

    .badge .k {
      color: var(--badge-key);
      font-weight: 600;
    }

    .badge .v {
      color: var(--badge-val);
      font-variant-numeric: tabular-nums;
    }

    /* планшет/десктоп */
    @media (min-width: 900px) {
      .layout {
        grid-template-columns: minmax(320px, 380px) 1fr;
        gap: 16px;
      }

      .panel {
        padding: 12px;
      }

      .list {
        max-height: calc(100vh - 220px);
      }

      .targets {
        min-height: calc(100vh - 220px);
      }
    }
  </style>
</head>

<body>
  <header class="header">
    <a style="text-decoration: none; color: black;" href="/utilities/utilities.html">⬅︎ Все инструменты</a>
    <h1>Транзитные направления Wildberries (FBW)</h1>
    <div class="topbar">
      <div class="search-wrap">
        <input type="text" id="search" placeholder="имя склада" />
      </div>
      <div class="controls">
        <button id="btnReload">Обновить</button>
      </div>
      <label class="checkbox">
        <input type="checkbox" id="onlyActive" /> Только активные
      </label>
    </div>
    <div class="status-row">
      <div id="statusCount" class="status-inline">Найдено направлений — 0</div>
      <div id="pageUpdated" class="page-updated">Обновлено: —:—:—</div>
    </div>
  </header>

  <main class="container">
    <div class="layout">
      <div class="panel">
        <h3>Транзитные склады</h3>
        <div class="hint">Кликните на склад — справа появятся назначения и цены</div>
        <div id="listA" class="list"></div>
      </div>
      <div class="panel">
        <h3>Склады назначения</h3>
        <div id="edges" class="targets">
          <div class="muted">Выберите склад слева</div>
        </div>
      </div>
    </div>
  </main>

  <script>
    const els = {
      statusCount: document.getElementById('statusCount'),
      pageUpdated: document.getElementById('pageUpdated'),
      listA: document.getElementById('listA'),
      edges: document.getElementById('edges'),
      onlyActive: document.getElementById('onlyActive'),
      search: document.getElementById('search'),
      btnReload: document.getElementById('btnReload'),
    };

    let fullData = [];
    let filtered = [];
    let currentAKey = null;

    function fmtDateRU(s) {
      if (!s) return '—';
      const d = new Date(s);
      if (isNaN(d.getTime())) return s;
      const dd = String(d.getDate()).padStart(2, '0');
      const mm = String(d.getMonth() + 1).padStart(2, '0');
      const yyyy = d.getFullYear();
      const hh = String(d.getHours()).padStart(2, '0');
      const mi = String(d.getMinutes()).padStart(2, '0');
      return `${dd}.${mm}.${yyyy} ${hh}:${mi}`;
    }
    function fmtTimeNow() {
      const d = new Date();
      const hh = String(d.getHours()).padStart(2, '0');
      const mm = String(d.getMinutes()).padStart(2, '0');
      const ss = String(d.getSeconds()).padStart(2, '0');
      return `${hh}:${mm}:${ss}`;
    }
    function perLiterLabel(min, max) {
      if (min == null && max == null) return '—';
      if (min != null && max == null) return `${min} ₽/л`;
      if (max != null && min == null) return `${max} ₽/л`;
      if (min === max) return `${min} ₽/л`;
      return `${min}–${max} ₽/л`;
    }

    function applyFilters() {
      const q = (els.search.value || '').trim().toLowerCase();
      filtered = fullData.filter((r) => {
        if (els.onlyActive.checked && r.active !== true) return false;
        const from = r.fromWarehouseName || '';
        const to = r.toWarehouseName || '';
        if (!q) return true;
        return from.toLowerCase().includes(q) || to.toLowerCase().includes(q);
      });
    }

    async function safeJson(res) {
      const text = await res.text();
      if (!text) return null;
      try { return JSON.parse(text); } catch { return null; }
    }

    async function loadData() {
      try {
        const res = await fetch('/api/wb-transit.php', {
          headers: { Accept: 'application/json' },
        });
        const data = await safeJson(res);
        fullData = res.ok && Array.isArray(data) ? data : [];
        els.pageUpdated.textContent = 'Обновлено: ' + fmtTimeNow();
      } catch {
        fullData = [];
        els.pageUpdated.textContent = 'Обновлено: ошибка';
      }
      currentAKey = null;
      onStateChanged();
    }

    function escapeHtml(v) {
      return String(v)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
    }

    function groupBySource(list) {
      const map = new Map();
      for (const r of list) {
        const key = (r.fromWarehouseName || '').toLowerCase();
        if (!map.has(key)) map.set(key, { key, name: r.fromWarehouseName || '—', items: [] });
        map.get(key).items.push(r);
      }
      return Array.from(map.values()).sort((a, b) =>
        String(a.name).localeCompare(String(b.name), 'ru'),
      );
    }

    function renderGraph() {
      const groups = groupBySource(filtered);

      els.statusCount.textContent = `Найдено направлений — ${filtered.length}`;

      els.listA.innerHTML = groups
        .map(
          (g) => `
            <div class="item ${g.key === currentAKey ? 'active' : ''}" data-key="${escapeHtml(
            g.key,
          )}">
              ${escapeHtml(g.name)}
              <div class="sub">направлений: ${g.items.length}</div>
            </div>
          `,
        )
        .join('');

      for (const el of els.listA.querySelectorAll('.item')) {
        el.addEventListener('click', () => {
          currentAKey = el.getAttribute('data-key');
          renderGraph();
        });
      }

      const selected =
        groups.find((g) => g.key === currentAKey) || groups[0] || null;
      if (!selected) {
        els.edges.innerHTML = `<div class="muted">Нет данных</div>`;
        return;
      }
      if (!currentAKey) currentAKey = selected.key;

      const edgesHtml = selected.items
        .sort((a, b) =>
          String(a.toWarehouseName || '').localeCompare(
            String(b.toWarehouseName || ''),
            'ru',
          ),
        )
        .map((r) => {
          const fromName = r.fromWarehouseName || '';
          const toName = r.toWarehouseName || '';
          const perLiter = perLiterLabel(r.boxMinPerLiter, r.boxMaxPerLiter);
          const pallet =
            r.palletTariff != null && r.palletTariff !== ''
              ? `${r.palletTariff} ₽/паллета`
              : '—';

          let statusClass = 'status-unknown';
          let statusText = 'Неизвестно';
          if (r.active === true) { statusClass = 'status-active'; statusText = 'Активно'; }
          else if (r.active === false) { statusClass = 'status-inactive'; statusText = 'Неактивно'; }

          return `
              <div class="card">
                <div class="card-head">
                  <span class="status-badge ${statusClass}">${statusText}</span>
                  <span class="title">${escapeHtml(fromName)} → ${escapeHtml(toName)}</span>
                </div>
                <div class="badges">
                  <span class="badge"><span class="k">За литр:</span><span class="v">${escapeHtml(perLiter)}</span></span>
                  <span class="badge"><span class="k">Паллета:</span><span class="v">${escapeHtml(pallet)}</span></span>
                  <span class="badge"><span class="k">Доступен с:</span><span class="v">${escapeHtml(fmtDateRU(r.updatedAt))}</span></span>
                </div>
              </div>
            `;
        })
        .join('');

      els.edges.innerHTML = edgesHtml || `<div class="muted">Нет связей</div>`;
    }

    function onStateChanged() {
      applyFilters();
      renderGraph();
    }

    els.onlyActive.addEventListener('change', onStateChanged);
    els.search.addEventListener('input', onStateChanged);
    els.btnReload.addEventListener('click', loadData);
    document.addEventListener('DOMContentLoaded', loadData);
  </script>
</body>

</html>